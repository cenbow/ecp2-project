<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ecp.dao.OrderItemsMapper">
  <resultMap id="BaseResultMap" type="com.ecp.entity.OrderItems">
    <!--
      WARNING - @mbggenerated
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="activites_detail_id" jdbcType="BIGINT" property="activitesDetailId" />
    <result column="area_id" jdbcType="BIGINT" property="areaId" />
    <result column="cid" jdbcType="BIGINT" property="cid" />
    <result column="contract_no" jdbcType="VARCHAR" property="contractNo" />
    <result column="coupon_discount" jdbcType="DECIMAL" property="couponDiscount" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="delivery_type" jdbcType="TINYINT" property="deliveryType" />
    <result column="integral" jdbcType="BIGINT" property="integral" />
    <result column="integral_discount" jdbcType="DECIMAL" property="integralDiscount" />
    <result column="item_id" jdbcType="BIGINT" property="itemId" />
    <result column="num" jdbcType="INTEGER" property="num" />
    <result column="order_id" jdbcType="VARCHAR" property="orderId" />
    <result column="pay_price" jdbcType="DECIMAL" property="payPrice" />
    <result column="pay_price_total" jdbcType="DECIMAL" property="payPriceTotal" />
    <result column="primitive_price" jdbcType="DECIMAL" property="primitivePrice" />
    <result column="promotion_discount" jdbcType="DECIMAL" property="promotionDiscount" />
    <result column="promotion_id" jdbcType="VARCHAR" property="promotionId" />
    <result column="promotion_type" jdbcType="VARCHAR" property="promotionType" />
    <result column="shop_freight_template_id" jdbcType="BIGINT" property="shopFreightTemplateId" />
    <result column="sku_id" jdbcType="BIGINT" property="skuId" />
    <result column="sku_name" jdbcType="VARCHAR" property="skuName" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="deleted" jdbcType="INTEGER" property="deleted" />
    <result column="highest_price" jdbcType="DECIMAL" property="highestPrice" />
    <result column="lowest_price" jdbcType="DECIMAL" property="lowestPrice" />
    <result column="hard_cost_price" jdbcType="DECIMAL" property="hardCostPrice" />
    <result column="is_plan_product" jdbcType="TINYINT" property="isPlanProduct" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
    -->
    id, activites_detail_id, area_id, cid, contract_no, coupon_discount, create_time, 
    delivery_type, integral, integral_discount, item_id, num, order_id, pay_price, pay_price_total, 
    primitive_price, promotion_discount, promotion_id, promotion_type, shop_freight_template_id, 
    sku_id, sku_name, update_time, deleted, highest_price, lowest_price, hard_cost_price, 
    is_plan_product
  </sql>
  
  <select id="selectItemsByOrderId" resultType="map">
  	select * from trade_order_items as o left join item_sku_picture as p
  	 on(o.sku_id=p.sku_id) 
	where p.deleted=1 and o.order_id=#{orderId} GROUP BY o.sku_id
  </select>
  
  <!-- 查询订单总金额 -->
  <select id="getOrderAmountByNo" resultType="java.math.BigDecimal">
	SELECT
		IFNULL(SUM(oi.pay_price_total), 0)
	FROM
		trade_order_items oi
	WHERE
		oi.order_id = #{orderNo}		  	 
  </select>
  <!-- 查询产品销售清单统计 -->
  <select id="getItemSalesStats" resultType="map" parameterType="map">
	SELECT
		o.order_id,
		o.extend_id,
		oi.id,
		oi.item_id,
		oi.sku_id,
		oi.sku_name,
		SUM(oi.num) AS sum_num,
		oi.primitive_price,
		SUM(oi.pay_price_total) AS pay_price_total,
		o.contract_state,
		oi.promotion_discount,
		SUM(
			oi.promotion_discount * oi.num
		) AS promotion_discount_total,
		o.create_time
	FROM
		trade_order_items oi
	LEFT JOIN trade_orders o ON oi.order_id = o.order_id
	LEFT JOIN user_extends ue ON o.extend_id = ue.extend_id
	LEFT JOIN cust_lock_rel l ON ue.extend_id = l.cust_id
	WHERE
		o.contract_state = 6<!-- 合同状态=执行完毕 -->
	AND o.extend_id IS NOT NULL
	<if test="start_time!=null and start_time!=''">
		and o.create_time &gt;= #{start_time}
	</if>
	<if test="end_time!=null and end_time!=''">
		and o.create_time &lt;= #{end_time}
	</if>
	<if test="user_id!=null and user_id>0">
		and l.bind_user_id = #{user_id}
	</if>
	<if test="role_id!=null and role_id>0">
		and l.role_id = #{role_id}
	</if>
	GROUP BY
		sku_id
	ORDER BY
		sum_num DESC	  	 
  </select>
  
</mapper>