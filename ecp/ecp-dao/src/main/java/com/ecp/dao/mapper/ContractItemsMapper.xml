<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ecp.dao.ContractItemsMapper">
  <resultMap id="BaseResultMap" type="com.ecp.entity.ContractItems">
    <!--
      WARNING - @mbggenerated
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="activites_detail_id" jdbcType="BIGINT" property="activitesDetailId" />
    <result column="area_id" jdbcType="BIGINT" property="areaId" />
    <result column="cid" jdbcType="BIGINT" property="cid" />
    <result column="contract_no" jdbcType="VARCHAR" property="contractNo" />
    <result column="coupon_discount" jdbcType="DECIMAL" property="couponDiscount" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="delivery_type" jdbcType="TINYINT" property="deliveryType" />
    <result column="integral" jdbcType="BIGINT" property="integral" />
    <result column="integral_discount" jdbcType="DECIMAL" property="integralDiscount" />
    <result column="item_id" jdbcType="BIGINT" property="itemId" />
    <result column="num" jdbcType="INTEGER" property="num" />
    <result column="order_id" jdbcType="VARCHAR" property="orderId" />
    <result column="pay_price" jdbcType="DECIMAL" property="payPrice" />
    <result column="pay_price_total" jdbcType="DECIMAL" property="payPriceTotal" />
    <result column="primitive_price" jdbcType="DECIMAL" property="primitivePrice" />
    <result column="promotion_discount" jdbcType="DECIMAL" property="promotionDiscount" />
    <result column="promotion_id" jdbcType="VARCHAR" property="promotionId" />
    <result column="promotion_type" jdbcType="VARCHAR" property="promotionType" />
    <result column="shop_freight_template_id" jdbcType="BIGINT" property="shopFreightTemplateId" />
    <result column="sku_id" jdbcType="BIGINT" property="skuId" />
    <result column="sku_name" jdbcType="VARCHAR" property="skuName" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="discount_price" jdbcType="DECIMAL" property="discountPrice" />
    <result column="deleted" jdbcType="INTEGER" property="deleted" />
    <result column="brand_name" jdbcType="VARCHAR" property="brandName" />
    <result column="model" jdbcType="VARCHAR" property="model" />
    <result column="parms" jdbcType="VARCHAR" property="parms" />
    <result column="highest_price" jdbcType="DECIMAL" property="highestPrice" />
    <result column="lowest_price" jdbcType="DECIMAL" property="lowestPrice" />
    <result column="hard_cost_price" jdbcType="DECIMAL" property="hardCostPrice" />
    <result column="is_plan_product" jdbcType="TINYINT" property="isPlanProduct" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
    -->
    id, activites_detail_id, area_id, cid, contract_no, coupon_discount, create_time, 
    delivery_type, integral, integral_discount, item_id, num, order_id, pay_price, pay_price_total, 
    primitive_price, promotion_discount, promotion_id, promotion_type, shop_freight_template_id, 
    sku_id, sku_name, update_time, discount_price, deleted, brand_name, model, parms, 
    highest_price, lowest_price, hard_cost_price, is_plan_product
  </sql>
  <select id="selectItemsByContractNo" resultType="map">
  	 select * from contract_items as o left join item_sku_picture as p
  	 on(o.sku_id=p.sku_id) 
	where  p.deleted=1 and o.contract_no=#{contractNo}  GROUP BY o.sku_id
  </select>
  
  <!-- 查询合同支付总金额 -->
  <select id="selectContractPayPriceTotal" resultType="java.math.BigDecimal">
	SELECT
		IFNULL(SUM(ci.pay_price_total), 0)
	FROM
		contract_items ci
	LEFT JOIN trade_orders o ON ci.order_id = o.order_id
	LEFT JOIN user_extends ue ON o.extend_id = ue.extend_id
	LEFT JOIN cust_lock_rel l ON ue.extend_id = l.cust_id
	WHERE
		o.contract_state = 6
		<if test="order_no!=null and order_no!=''">
  			and o.order_id = #{order_no}	
  		</if>
  		<if test="start_time!=null and start_time!=''">
			and o.create_time &gt;= #{start_time}
		</if>
		<if test="end_time!=null and end_time!=''">
			and o.create_time &lt;= #{end_time}
		</if>
  	 	<if test="provinceName!=null and provinceName!=''">
  			and ue.province=#{provinceName} 
  		</if>  		
  		<if test="cityName!=null and cityName!=''">
  			and ue.city=#{cityName} 
  		</if>
  		<if test="countyName!=null and countyName!=''">
  			and ue.county=#{countyName} 
  		</if>
  		<if test="user_id!=null">
  			and l.bind_user_id=#{user_id} 
  		</if>
  		<if test="role_id!=null">
			and l.role_id=#{role_id}
		</if>
  </select>
  
  
  <!-- 查询合同支付总金额 -->
  <select id="getContractAmountByNo" resultType="java.math.BigDecimal">
	SELECT
		IFNULL(SUM(ci.pay_price_total),0)
	FROM
		contract_items ci	
	WHERE
		ci.contract_no = #{contractNo}		  	 
  </select>
  
  
  
  <!-- 查询合同商品列表，用于提成的计算 -->
  <select id="selectContractItems" resultType="map">
	SELECT
		ci.*, ue.*
	FROM
		contract_items ci
	LEFT JOIN trade_orders o ON ci.order_id = o.order_id
	LEFT JOIN user_extends ue ON o.extend_id = ue.extend_id
	WHERE
		o.contract_state = 6 
		<if test="agent_id_list!=null and agent_id_list.size()>0">
			and ue.extend_id IN 
			<!-- r.role_code IN (42) -->
			<foreach collection="agent_id_list" index="index" item="item" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="start_time!=null and start_time!=''">
			and o.create_time &gt;= #{start_time}
		</if>
		<if test="end_time!=null and end_time!=''">
			and o.create_time &lt;= #{end_time}
		</if>
  	 	<if test="provinceName!=null and provinceName!=''">
  			and ue.province=#{provinceName} 
  		</if>  		
  		<if test="cityName!=null and cityName!=''">
  			and ue.city=#{cityName} 
  		</if>
  		<if test="countyName!=null and countyName!=''">
  			and ue.county=#{countyName} 
  		</if>
  </select>
  
  <!-- 查询范围内合同总金额 -->
  <select id="searchContractAmount" resultType="java.math.BigDecimal">
		select IFNULL(SUM(ci.pay_price_total),0) from contract_items ci 
						LEFT JOIN trade_orders o  on(o.order_id=ci.order_id) 
						LEFT JOIN user_extends a  on(o.extend_id=a.extend_id)				  
					   
		<where>
			o.deleted=1 AND o.yn=1 and o.extend_id is not NULL AND
			ci.contract_no is not NULL	AND
			o.create_time&gt;=DATE_ADD(now(),INTERVAL #{orderTimeCond} MONTH)
			<if test="dealStateCond!=null and dealStateCond!='' and dealStateCond!='0'.toString()">
				AND 
				o.contract_state=#{dealStateCond}	
			</if>
			<if test="condValue!=null and condValue!=''">
				<choose>  			
					<when test="searchTypeValue==1">  					
						AND o.order_id LIKE concat(concat('%',#{condValue}),'%') 
					</when>
					<when test="searchTypeValue==2">
						AND o.contract_no LIKE concat(concat('%',#{condValue}),'%') 
					</when>
					<when test="searchTypeValue==3">
						AND o.name LIKE concat(concat('%',#{condValue}),'%') 
					</when>
					<when test="searchTypeValue==4">
						AND o.mobile LIKE concat(concat('%',#{condValue}),'%') 
					</when>
					<when test="searchTypeValue==5">
						AND a.company_name LIKE concat(concat('%',#{condValue}),'%') 
					</when>
					<when test="searchTypeValue==6">
						AND a.artificial_person_name LIKE concat(concat('%',#{condValue}),'%') 
					</when>
					<when test="searchTypeValue==7">
						AND a.contact_phone LIKE concat(concat('%',#{condValue}),'%') 
					</when>  			
				</choose>  						
			</if>
  		
  			<!-- 区域条件 -->
			<if test="provinceName!=null and provinceName!=''">
				AND a.province=#{provinceName} 
			</if>  		
			<if test="cityName!=null and cityName!=''">
				AND a.city=#{cityName} 
			</if>
			<if test="countyName!=null and countyName!=''">
				AND a.county=#{countyName} 
			</if>
			
			
			
			<!-- 数据范围 -->  		
			<if test="agentIdList!=null and agentIdList.size&gt;=0">
				<if test="agentIdList.size&gt;0">
					AND a.extend_id in
					<foreach close=")" collection="agentIdList" index="index" item="item" open="(" separator=",">
						#{item.cust_id}
					</foreach>
				</if>
				
				<if test="agentIdList.size==0">
					and (0&gt;1)
				</if>
							 
			</if>
			
			<!-- 回款类型 -->
			<if test="totalPayFlag!=-1">
				AND o.total_pay_flag=#{totalPayFlag}
			</if>  		
			
		 </where>  	 
  	 	 	 
  	</select>
  
  
</mapper>