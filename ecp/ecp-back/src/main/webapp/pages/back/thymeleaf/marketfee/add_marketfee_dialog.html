<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>

	<th:block th:fragment="dialog">

		<div class="row clearfix">
			<div class="col-md-12 column">

				<!--  <a id="modal-306690" href="#modal-container-306690" role="button" class="btn" data-toggle="modal" type="hidden"></a> -->
				<div class="modal fade" id="modal-container-306690" role="dialog"
					aria-labelledby="myModalLabel" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal"
									aria-hidden="true">×</button>
								<h4 class="modal-title" id="myModalLabel">增加市场费<span class="add-marketfee-info"></span></h4>
							</div>
							<div class="modal-body">
								<form class="form-horizontal" role="form">
									<!-- 费用期间 -->
									<div class="form-group">
										<label for="accountItemPeriod" class="col-sm-2 control-label">期间</label>
										<div class="col-sm-10">
											<input class="datetimepicker datetime form-control"
												readonly="readonly" id="accountItemPeriod" type="text"
												onClick="WdatePicker({dateFmt:'yyyy-MM'});" />
										</div>
									</div>
									
									<!-- 费用类型 -->
									<div class="form-group">
										<label for="accountItemType" class="col-sm-2 control-label">类型</label>
										<div class="col-sm-10">
											<select class="form-control" id="accountItemType"
												name="itemType">
												<!-- <option value="1">交通费</option>
												<option value="2">通讯费</option>
												<option value="3">招待费</option>
												<option value="4">差旅费</option> -->
												<option value="5">市场费</option>
											</select>
										</div>
									</div>

									<!-- 选择人员 -->
									<div class="form-group">
										<label for="belongTo" class="col-sm-2 control-label">归属</label>
										<div class="col-sm-10">
											<span th:if="${not #lists.isEmpty(bindUserList)}" th:remove="tag">
												<span th:each="bindUser:${bindUserList}" th:remove="tag">
													<input type="checkbox"  th:attr="id='bind-user-'+${bindUser.rel_id},data-bind-id=${bindUser.rel_id}" class="bind-user" />
													<label th:attr="for='bind-user-'+${bindUser.rel_id}" th:text="${bindUser.username}+'('+${bindUser.role_code}+')'"></label>
												</span>
											</span>
											<span th:if="${#lists.isEmpty(bindUserList)}" th:remove="tag">
												<span>公司内部费用									
												</span>
											</span>
											
											
										</div>
									</div>
									

									<!-- 金额 -->
									<div class="form-group">
										<label for="amount" class="col-sm-2 control-label">金额</label>
										<div class="col-sm-10">
											<input type="number" class="form-control" id="amount"
												name="amount" />
										</div>
									</div>

									<!-- 备注 -->
									<div class="form-group">
										<label for="comment" class="col-sm-2 control-label">备注</label>
										<div class="col-sm-10">
											<input type="text" class="form-control" id="comment"
												name="comment" />
										</div>
									</div>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-default"
									data-dismiss="modal">关闭</button>
								<button type="button" class="btn btn-primary"
									id="btn-save-market-fee">保存</button>
							</div>
						</div>

					</div>

				</div>

			</div>
		</div>

	</th:block>
	
	<script th:inline="javascript">
	/*<![CDATA[*/
	    var curr_bindUserList=[[${bindUserList}]];	//动态加载增加市场费对话框时赋值.
	/*]]>*/
	</script>
	
	<script type="text/javascript">
	
	
	
	//-------------------前端数据操作------------------
	/**
	 * 返回绑定用户列表(自服务器返回的参数)
	 */
	function getBindUserList(){
		return curr_bindUserList;
	}


	/**
	 * 设定绑定用户列表的状态
	 * @param status  true/false;
	 * @returns
	 */
	function setBindUserCheckStatus(status){
		var bindUserList=getBindUserList();

		for(i=0;i<bindUserList.length;i++){
			bindUserList[i].selected=status;
		}
	}

	//------------------业务操作----------------------
	/**
	 * 保存市场费用条目:增加
	 * @returns
	 */
	function addMarketFeeItem(){
		var urlStr = BASE_CONTEXT_PATH + "/back/marketfee/add"; // 需要提交的url
		
		/*var params=new Object();  //生成参数对象.
		
		params.agentId=agentId;
		params.userList=userList;*/
		
		var orderId=curr_orderId;
		var orderNo=curr_orderNo;
		
		//自对话框中取得所输入的值
		var itemType=$('#accountItemType').val();
		var amount=$('#amount').val();
		var comment=$('#comment').val();
		
		//期间(格式:  yyyy-MM)
		var period=$('#accountItemPeriod').val();
		

		$.ajax({
			type : "POST", // 提交方式 get/post
			url : urlStr,
			//contentType : "application/json", // 如果采用json格式传送所有参数时必须有,如果采普通js对象传送时,则不可以加此参数
			//dataType : "html", //表示返回值类型，不必须,如果返回的是面页，则必须
			data : {
				'orderId':orderId,
				'orderNo':orderNo,
				'itemType':itemType,
				'amount':amount,
				'comment':comment,
				'bindUserList':JSON.stringify(curr_bindUserList),
				'period':period
			},
			success : function(res) { // data 保存提交后返回的数据，一般为 json 数据
				//console.log(res);
				if (res != null && res != "") {
					var obj = $.parseJSON(res);
					if (obj.result_code == "success") {
						//util.message(obj.result_msg);
						//var urlTemp = obj.result_msg;
						loadmarketFeeTable();
						search_normal();//重新加载订单列表的当前页.
						closeAddmarketFeeDialog();
						
					} else {
						util.message(obj.result_msg);
					}
				}
			},
			error : function(jqXHR, textStatus, errorThrown) {
				util.message("AJAX请求时发生错误!");
				/* 弹出jqXHR对象的信息 */
				console.log(jqXHR.responseText);
				console.log(jqXHR.status);
				console.log(jqXHR.readyState);
				console.log(jqXHR.statusText);
				/* 弹出其他两个参数的信息 */
				console.log(textStatus);
				console.log(errorThrown);

			}
		});
	}
	
	
	$(function(){
		$("#accountItemPeriod").val((new Date()).format('yyyy-MM'));
		
		
		
		
		//选定/取消选定用户
		$(".bind-user").on("change",function(){
			var checkState=$(this).is(":checked");
			
			var currRelId=$(this).attr("data-bind-id");
			//console.log("bind user relid is:"+bindUserRelId);
			
			//置绑定用户的选定状态.
			var bindUserList=getBindUserList();  //获取绑定用户列表.
			for(i=0;i<bindUserList.length;i++){
				if(bindUserList[i].rel_id==currRelId){
					bindUserList[i].selected=checkState;
					return;
				}
			}
			
		})
		
		//保存费用条目button:click event
		$('#btn-save-market-fee').on('click',function(){		
			addMarketFeeItem();
			//closeAddmarketFeeDialog();
		})
		
		
	});
		
	
	</script>

</body>
</html>