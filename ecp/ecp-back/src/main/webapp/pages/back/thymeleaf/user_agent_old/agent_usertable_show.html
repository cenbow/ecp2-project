<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<!-- 功能描述,操作面板 -->
	<div class="row clearfix">
		<!-- 分配帐号对话框 -->
		<div
			th:replace="/back/thymeleaf/common/_dispatch_account_dialog::dialog"
			class="header"></div>

		<div class="col-md-12 column">
			<h5 style="">
				<span>签约代理商:</span> <span id="curr-companyName"
					style="font-size: 14px; font-weight: bold"></span> <span>-帐号列表.</span>
			</h5>
			<div style="float: right; margin-right: 150px;">
				<i class=" icon-plus-sign-alt icon-large dispatch-account"
					style="color: darkblue;" title="增加帐号"></i>
			</div>
		</div>
	</div>
	<!-- 代理商用户列表 -->
	<div class="row clearfix">
		<div class="col-md-12 column" id="agent-user-table">
			<div th:include="/back/thymeleaf/user_agent/agent_usertable"></div>
		</div>
	</div>

	<script>
		
		//-----------------全局变量--------------------
		var EDIT_MODE_ADD=1;  //编辑模式:增加
		var EDIT_MODE_MODI=2; //编辑模式:修改
		var g_editMode=null; //编辑械式变量;
	
	
		//-------------------公共函数----------------------
		/*用于判定是否为空*/
		(function($){
			$.isBlank = function(obj){
			return(!obj || $.trim(obj) === "");
				  };
		})(jQuery);
	
		
		//------------------UI部分---------------------

		/*
		 *显示公司名称
		 */
		function displayCompanyName() {
			var companyName = $("#companyName").val(); //来自于选项卡中隐藏字段
			$("#curr-companyName").text(companyName);
		}
		
	
		// ===============分配(增加)帐号对话框 open/close==================
		/*
		 * 显示分配帐户窗口
		 */
		function displayWindow() {
			$('#modal-container-273078').modal({
				backdrop : 'static',
				keyboard : false
			});
		}

		/* 关闭分配帐户窗口 */
		function closeWindow() {
			$("#modal-container-273078").modal("hide");
		}

		//-------------------业务功能部分----------------------
		
		
		/*
		 * 请求:分配(ADD)帐号--->发送浦请求到后台.
		 * @returns
		 */
		function dispatchAccount() {
			var loginName = $("#loginName").val();
			var nickName = $("#nickName").val();
			var password = $("#password").val();
			
			var agentId = curr_agentId;  //当前代理商ID  
			console.log("agentId"+agentId);
			
			
			var url = BASE_CONTEXT_PATH + "/back/agent/dispatch"; // 需要提交的 url
			$.ajax({
				type : "post", // 提交方式 get/post
				url : url, // 需要提交的 url
				// dataType: "application/json",
				data : {
					"loginName" : loginName,
					"nickName" : nickName,
					"password" : password,
					"agentId" : agentId
				},
				success : function(res) { // data 保存提交后返回的数据，一般为 json 数据
					console.log(res);
					if (res != null && res != "") {
						var obj = $.parseJSON(res);
						if (obj.result_code == "success") {
							//生成帐号成功 重新加载页面
							//util.message("成功分配帐号！");
							reloadUserPage();
							reloadPage();

						} else { 
							util.message(obj.result_msg);
						}
					}
				}

			});
		}
		 
		 
		 /*
		 * 请求:MODI帐号--->发送浦请求到后台.
		 * @returns
		 */
		function modiAccount() {
			var loginName = $("#loginName").val();
			var nickName = $("#nickName").val();
			var password = $("#password").val();
			
			var agentId = curr_agentId;  //当前代理商ID
			var userId=$("#modi-user-id").val();
			
			
			//console.log("agentId"+agentId);
			
			
			var url = BASE_CONTEXT_PATH + "/back/agent/modiuser"; // 需要提交的 url
			$.ajax({
				type : "post", // 提交方式 get/post
				url : url, // 需要提交的 url
				// dataType: "application/json",
				data : {
					"loginName" : loginName,
					"nickName" 	: nickName,
					"password" 	: password,
					"agentId" 	: agentId,
					"userId"  	: userId
				},
				success : function(res) { // data 保存提交后返回的数据，一般为 json 数据
					console.log(res);
					if (res != null && res != "") {
						var obj = $.parseJSON(res);
						if (obj.result_code == "success") {
							//修改帐号成功 重新加载页面
							//util.message("成功修改帐号！");
							reloadUserPage();
							reloadPage();

						} else { 
							util.message(obj.result_msg);
						}
					}
				}

			});
		}
		 
		 
		 
		
		/*重新加载用户列表*/
		function reloadUserPage(){
			var container="#agent-user-table";
			var url = BASE_CONTEXT_PATH + "/back/agent/usertable"; // 需要提交的 url
			
			var parms=new Object();
			parms.agentId=curr_agentId;
			
			$(container).load(url,parms,function(){
				
			});
		}

		//------------------帐号的有效性判定部分--------------------
		/**
		 * 判定用户帐号的有效性
		 * @returns
		 * 		0：正确; 		
		 * 		2:字段为空
		 */
		function validUserAccount() {
			var loginName = $("#loginName").val();
			var nickName = $("#nickName").val();//默认的昵称为手机号码
			var password = $("#password").val();
			
			if(g_editMode==EDIT_MODE_ADD){
				if ($.isBlank(loginName) || $.isBlank(nickName)
						|| $.isBlank(password)) {
					return 2;
				} else {
					return 0;
				}	
			}
			else{
				if ($.isBlank(loginName) || $.isBlank(nickName)){
					return 2;
				} else {
					return 0;
				}
			}
			
		}
		
		/**
		 * 用户登录名称是否重复?如果不重复则向服务器发送数据.
		 * 采用AJAX来判定是否登录用户重复
		 * @returns
		 */
		function hasSameLoginName() {
			var loginName = $("#loginName").val();
			var url = BASE_CONTEXT_PATH + "/back/agent/sameloginname"; // 需要提交的 url
			$.ajax({
				type : "post", // 提交方式 get/post
				url : url, // 需要提交的 url
				// dataType: "application/json",
				data : {
					'loginName' : loginName,
				},
				success : function(res) { // data 保存提交后返回的数据，一般为 json 数据
					console.log(res);
					if (res != null && res != "") {
						var obj = $.parseJSON(res);
						if (obj.result_code == "success") { //有重复的帐号
							if(g_editMode==EDIT_MODE_ADD){
								util.message("有相同的帐号，请重新输入新登录名称！");	
							}
							else{  //EDIT_MODE_MODI
								closeWindow(); //关闭窗口
								modiAccount();  //修改帐号
							}
							
						} else { //此帐号不重复
							//util.message(obj.result_msg);
							closeWindow(); //关闭窗口
							if(g_editMode==EDIT_MODE_ADD){
								dispatchAccount(); //分配(Add)帐号
							}
							else{
								modiAccount();  //修改帐号	
							}
									
									
						}
					}
				}

			});
		}


		$(function() {

			//---------------显示公司名称--------------------
			displayCompanyName();
			

			// ====================帐户管理=====================
			/* 【增加帐户】按钮-click event process
				显示对话框 
			 */
			$(".dispatch-account").on("click", function(e) {
				var defaultPassword = "123456";

				g_editMode=EDIT_MODE_ADD;  //设置编辑模式
				document.getElementById("dispatch-form").reset(); //(表单reset)清空所有编辑框 
				//设置对话框中显示的内容
				var companyName=$("#curr-companyName").text();
				$("#myModalLabel").text("公司名称:" + companyName+"(增加帐号)");
				
				$("#password").val(defaultPassword);//默认的帐户密码是：123456
				$(".password-desc").text(defaultPassword);  //显示:默认的口令说明
				
				
				
				//显示增加帐号对话框
				displayWindow();  
				
				

			});

			/*分配/编辑帐户：确认按钮-click event processor*/
			$("#btnDispatch").on("click", function() {
				//console.log("debug1");
				
				var result = validUserAccount();
				if (result == 2) {
					util.message("字段不可以为空!");
					return;
				}

				hasSameLoginName(); //判定登录名称是否重复
			});

			

		});
	</script>
</body>
</html>