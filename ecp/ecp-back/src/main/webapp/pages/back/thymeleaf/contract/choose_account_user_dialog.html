<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>选择计费用户对话框</title>
</head>
<body>

	<th:block th:fragment="dialog">

		<div class="row clearfix">
			<div class="col-md-12 column">
				<!-- 合同完成时选择IS/OS对话框 -->
				<div class="modal fade" id="choose-account-user-dialog" role="dialog"
								aria-labelledby="accountUserModalLabel" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal"
									aria-hidden="true">×</button>
								<h4 class="modal-title" id="accountUserModalLabel">选择业绩归属</h4>
							</div>
							<div class="modal-body">
								<form class="form-horizontal" role="form">
									<!-- 选择人员 -->
									<div class="form-group">
										<label for="belongTo" class="col-sm-2 control-label">业绩归属</label>
										<div class="col-sm-10" id="bind-user-item">
											<span th:if="${not #lists.isEmpty(bindUserList)}" th:remove="tag">
												<span th:each="bindUser:${bindUserList}" th:remove="tag">
													<input type="checkbox"  th:attr="id='bind-user-'+${bindUser.rel_id},data-user-id=${bindUser.id},data-role-id=${bindUser.role_id},data-bind-id=${bindUser.rel_id}" class="bind-user" />
													<label th:attr="for='bind-user-'+${bindUser.rel_id}" th:text="${bindUser.username}+'('+${bindUser.role_code}+')'"></label>
												</span>
											</span>
										</div>
									</div>
									<!-- 选择归属年月 -->
									<div class="form-group">
										<label for="belongTo" class="col-sm-2 control-label">归属年月</label>
										<div class="col-sm-10">
											<input type="text" id="account-year-month" name="" title="归属年月"
													class="datetimepicker datetime form-control"
													readonly="readonly" placeholder="归属年月"
													onClick="WdatePicker({dateFmt:'yyyy-MM'})" />
													<!-- onClick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})" /> -->
										</div>
									</div>
								</form>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-default"
									data-dismiss="modal">关闭</button>
								<button type="button" class="btn btn-primary"
									id="save-bind-user-btn" data-dismiss="modal">保存</button>
							</div>
						</div>
				
					</div>
				
				</div>
			</div>
		</div>
	<script th:inline="javascript">
		/*<![CDATA[*/
		    
		    var curr_accountStatus=[[${accountStatus}]];
		    var curr_orderId=[[${orderId}]];
		    var curr_contractId=[[${contractId}]];
		    var curr_year=[[${year}]];
		    var curr_month=[[${month}]];
		    
		/*]]>*/
	</script th:inline="javascript">
	<script>
		//初始化归属年月
		$("#account-year-month").val(curr_year+"-"+curr_month);
		
		initBindUserCheckedStatus();
		function initBindUserCheckedStatus(){
			//根据订单的记帐状态  全选/全不选 所绑定的用户.
			if(curr_accountStatus==null  || curr_accountStatus==1){
				$(".bind-user").prop("checked",true);//置所有用户的选择状态为选中
			}else{  //accountStatus==2;
				$(".bind-user").prop("checked",false);//置所有用户的选择状态为非选中
			}
		}
		/**
		 * 获取用户选择的计费用户
		 */
		function getCheckedBindUser(){
			var bindUserList = new Array();
			$("#bind-user-item input[type=checkbox]:checked").each(function(){
				var userId = $(this).attr("data-user-id");
				var roleId = $(this).attr("data-role-id");
				var obj = new Object();
				obj.userId = userId;
				obj.roleId = roleId;
				bindUserList.push(obj);
			});
			return JSON.stringify(bindUserList);
		}
		/**
		 * 选择计费用户后保存
		 */
		$("#save-bind-user-btn").on("click", function(){
			var year = null;
			var month = null;
			var accountYearMonth = $("#account-year-month").val();
			if(accountYearMonth!=null && accountYearMonth!=""){
				var arr = accountYearMonth.split("-");
				year = arr[0];
				month = arr[1];
			}
			
			var bindUserJSON = getCheckedBindUser();
			console.log(bindUserJSON);
			var status = 6;//完成
			setContractStatus(curr_orderId, curr_contractId, status, bindUserJSON, year, month);//设置合同状态并记账
		});
	</script>
	</th:block>

</body>
</html>